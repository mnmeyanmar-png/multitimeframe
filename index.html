<script>
        // --- DOM Elements ---
        const analyzeBtn = document.getElementById('analyze-btn');
        const loadingIndicator = document.getElementById('loading');
        const analysisOutput = document.getElementById('analysis-output');
        const placeholderText = document.getElementById('placeholder-text');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const inputs = document.querySelectorAll('.timeframe-input');
        const removeBtns = document.querySelectorAll('.remove-btn');

        // --- State ---
        let uploadedImages = {
            weekly: null,
            daily: null,
            h4: null,
            h1: null,
            m15: null,
            m5: null
        };

        // --- Event Listeners ---
        inputs.forEach(input => {
            input.addEventListener('change', handleFileSelect);
        });

        removeBtns.forEach(btn => {
            btn.addEventListener('click', handleRemoveImage);
        });

        analyzeBtn.addEventListener('click', handleAnalysis);

        // --- File Handling Functions ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const timeframe = event.target.id.split('-')[0]; // e.g., "weekly"
            const previewId = event.target.dataset.target;
            const previewContainer = document.getElementById(previewId);
            const previewImg = previewContainer.querySelector('img');

            const reader = new FileReader();
            reader.onload = e => {
                const base64Data = e.target.result;
                uploadedImages[timeframe] = base64Data;
                previewImg.src = base64Data;
                previewContainer.style.display = 'block';
                checkAnalyzeButtonState();
            };
            reader.readAsDataURL(file);
        }

        function handleRemoveImage(event) {
            const inputId = event.target.dataset.target;
            const input = document.getElementById(inputId);
            const timeframe = inputId.split('-')[0];
            const previewContainer = document.getElementById(input.dataset.target);

            // Reset state
            input.value = null; // Clear file input
            uploadedImages[timeframe] = null;
            previewContainer.style.display = 'none';
            previewContainer.querySelector('img').src = '';
            
            checkAnalyzeButtonState();
        }

        function checkAnalyzeButtonState() {
            const hasImages = Object.values(uploadedImages).some(img => img !== null);
            analyzeBtn.disabled = !hasImages;
        }

        // --- (UPDATED) Analysis Function ---
        async function handleAnalysis() {
            // 1. Setup UI for loading
            loadingIndicator.classList.remove('hidden');
            analysisOutput.innerHTML = ''; // Clear previous results
            placeholderText.classList.add('hidden');
            errorMessage.classList.add('hidden');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'ခွဲခြမ်းစိတ်ဖြာနေသည်...';

            try {
                // 2. Check if there are images (client-side check)
                const hasImages = Object.values(uploadedImages).some(img => img !== null);
                if (!hasImages) {
                    throw new Error("ကျေးဇူးပြု၍ အနည်းဆုံး chart ပုံ တစ်ပုံကို upload လုပ်ပါ။");
                }

                // 3. Call OUR OWN Vercel API endpoint
                const response = await fetch('/api/analyze-tda', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ uploadedImages: uploadedImages })
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error || `Server error ${response.status}`);
                }

                const data = await response.json();

                // 4. Display results
                analysisOutput.innerHTML = simpleMarkdownToHtml(data.result);
                
            } catch (err) {
                console.error('Analysis Error:', err);
                errorText.textContent = `An error occurred: ${err.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                // 5. Reset UI
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ခွဲခြမ်းစိတ်ဖြာပါ (Analyze)';
                checkAnalyzeButtonState(); // Re-enable if images are still present
            }
        }
        
        // --- (REMOVED) `callGeminiWithBackoff` function is no longer needed here ---

        // --- Utility Function (Keep this) ---
        function simpleMarkdownToHtml(text) {
             if (!text) return ''; // Add a check for undefined text
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italic
                .replace(/^## (.*$)/gim, '<h2>$1</h2>') // H2
                .replace(/^### (.*$)/gim, '<h3>$1</h3>') // H3
                .replace(/^- (.*$)/gim, '<ul><li>$1</li></ul>') // Basic lists (simple)
                .replace(/<\/ul>\s*<ul>/gim, '') // Merge adjacent list items
                .replace(/\n/g, '<br>'); // Newlines
        }

    </script>
</body>
</html>
